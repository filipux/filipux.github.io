<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto P2P WebRTC</title>
</head>
<body>
    <h1>Auto P2P WebRTC</h1>
    <h2>Device Info:</h2>
    <pre id="device-info">Waiting for connection...</pre>
    <h2>Messages:</h2>
    <ul id="messages"></ul>

    <script>
        let pc = new RTCPeerConnection();
        let dataChannel;
        let isHost = !localStorage.getItem("webrtc-host"); // First device is the host
        let signalStorageKey = "webrtc-signal"; // Shared storage key

        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                timestamp: new Date().toISOString()
            };
        }

        function logMessage(msg) {
            document.getElementById("messages").innerHTML += `<li>${msg}</li>`;
        }

        function sendMessage(msg) {
            if (dataChannel && dataChannel.readyState === "open") {
                dataChannel.send(msg);
                logMessage("You: " + msg);
            }
        }

        function setupDataChannel(channel) {
            dataChannel = channel;
            dataChannel.onopen = () => {
                console.log("Connected!");
                sendMessage(JSON.stringify({ type: "device-info", data: getDeviceInfo() }));
            };
            dataChannel.onmessage = (event) => {
                let receivedData = JSON.parse(event.data);
                if (receivedData.type === "device-info") {
                    document.getElementById("device-info").textContent = JSON.stringify(receivedData.data, null, 2);
                } else {
                    logMessage("Peer: " + event.data);
                }
            };
        }

        async function startConnection() {
            if (isHost) {
                dataChannel = pc.createDataChannel("device-info");
                setupDataChannel(dataChannel);
                let offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                localStorage.setItem(signalStorageKey, JSON.stringify({ offer }));
                localStorage.setItem("webrtc-host", "true"); // Mark this device as the host
            } else {
                pc.ondatachannel = (event) => setupDataChannel(event.channel);
            }
        }

        async function checkForSignal() {
            let storedData = JSON.parse(localStorage.getItem(signalStorageKey));
            if (!storedData) return;

            if (storedData.offer && !isHost) {
                await pc.setRemoteDescription(new RTCSessionDescription(storedData.offer));
                let answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                localStorage.setItem(signalStorageKey, JSON.stringify({ answer }));
            } else if (storedData.answer && isHost) {
                await pc.setRemoteDescription(new RTCSessionDescription(storedData.answer));
                localStorage.removeItem(signalStorageKey); // Clean up after connection
            }
        }

        // Poll for WebRTC signals
        setInterval(checkForSignal, 1000);

        // Start WebRTC
        startConnection();
    </script>
</body>
</html>
